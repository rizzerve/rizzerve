<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>My Profile</title>
</head>
<body>
<h1>Admin Profile</h1>
<div>
    <strong>Name:</strong> <span id="name"></span><br/>
    <strong>Username:</strong> <span id="username"></span>
</div>
<p>
    <a th:href="@{/admin/profile/editform}">Edit Profile</a> |
    <button id="deleteBtn">Delete Account</button> |
    <button id="logoutBtn">Log Out</button>
</p>

<script>
    // helper to detect JWT expiry
    function isTokenExpired(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return Date.now()/1000 > payload.exp;
        } catch {
            return true;
        }
    }

    const token = localStorage.getItem('jwtToken');
    if (!token || isTokenExpired(token)) {
        alert('Please log in (or your session expired).');
        localStorage.removeItem('jwtToken');
        document.cookie = 'jwt=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT';
        window.location.href = '/admin/login';
    }

    // load profile data
    fetch('/admin/profile', {
        headers: { 'Authorization': 'Bearer ' + token }
    })
        .then(r => {
            if (r.status === 403) throw 'forbidden';
            return r.json();
        })
        .then(data => {
            document.getElementById('name').innerText = data.name;
            document.getElementById('username').innerText = data.username;
        })
        .catch(() => {
            alert('Not authorizedâ€”please log in again.');
            localStorage.removeItem('jwtToken');
            document.cookie = 'jwt=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT';
            window.location.href = '/admin/login';
        });

    // delete account
    document.getElementById('deleteBtn').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to delete your account?')) return;
        const resp = await fetch('/admin/profile', {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
        });
        if (resp.status === 204) {
            alert('Account deleted.');
            localStorage.removeItem('jwtToken');
            document.cookie = 'jwt=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT';
            window.location.href = '/admin/login';
        } else {
            alert('Failed to delete account.');
        }
    });

    // logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('jwtToken');
        document.cookie = 'jwt=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT';
        window.location.href = '/admin/login';
    });
</script>
</body>
</html>
