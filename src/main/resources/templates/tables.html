<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Manage Tables</title>
    <meta charset="UTF-8"/>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-3xl mx-auto py-8">
        <h1 class="text-3xl font-bold mb-6 text-center">Restaurant Tables</h1>

        <!-- Alert message area -->
        <div id="alertMessage" class="hidden mb-4 p-4 rounded"></div>

        <div class="bg-white p-6 rounded shadow mb-8">
            <h2 class="text-xl font-semibold mb-4">Add New Table</h2>
            <form id="addTableForm" class="flex gap-4 items-end">
                <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
                <div>
                    <label for="tableNumber" class="block text-sm font-medium text-gray-700">Table Number:</label>
                    <input type="text" id="tableNumber" name="tableNumber" required
                        class="mt-1 block w-full rounded border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
                </div>
                <button type="submit"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Add Table</button>
            </form>
        </div>

        <div class="bg-white p-6 rounded shadow">
            <h2 class="text-xl font-semibold mb-4">All Tables</h2>
            <div class="overflow-hidden">
                <table class="min-w-full border border-gray-200 rounded">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 border-b text-left">ID</th>
                            <th class="px-4 py-2 border-b text-left">Table Number</th>
                            <th class="px-4 py-2 border-b text-left">Occupied</th>
                            <th class="px-4 py-2 border-b text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Table rows will be loaded here via AJAX -->
                        <tr>
                            <td colspan="4" class="px-4 py-2 text-center">Loading tables...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add JavaScript for AJAX functionality -->
    <script th:inline="javascript">
        // CSRF token for secure AJAX requests
        const csrfToken = /*[[${_csrf != null ? _csrf.token : null}]]*/ null;
        const csrfHeader = /*[[${_csrf != null ? _csrf.headerName : 'X-CSRF-TOKEN'}]]*/ 'X-CSRF-TOKEN';
        let editingTableId = null;
        
        // Function to show alert message
        function showAlert(message, isError = false) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.textContent = message;
            alertDiv.className = isError 
                ? 'mb-4 p-4 rounded bg-red-100 text-red-700' 
                : 'mb-4 p-4 rounded bg-green-100 text-green-700';
            alertDiv.classList.remove('hidden');
            setTimeout(() => alertDiv.classList.add('hidden'), 5000);
        }

        // Function to load all tables
        function loadTables() {
            fetch('/api/tables')
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load tables');
                    return response.json();
                })
                .then(tables => {
                    renderTables(tables);
                })
                .catch(error => {
                    showAlert('Error loading tables: ' + error.message, true);
                });
        }

        // Function to render tables in the table
        function renderTables(tables) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            if (tables.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4" class="px-4 py-2 text-center">No tables found</td>';
                tableBody.appendChild(row);
                return;
            }
            
            tables.forEach(table => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Table ID cell
                const idCell = document.createElement('td');
                idCell.className = 'px-4 py-2 border-b';
                idCell.textContent = table.id;
                row.appendChild(idCell);
                
                // Table number cell
                const numberCell = document.createElement('td');
                numberCell.className = 'px-4 py-2 border-b';
                
                if (editingTableId === table.id) {
                    // Edit form
                    const form = document.createElement('form');
                    form.className = 'flex gap-2';
                    form.innerHTML = `
                        <input type="text" name="newTableNumber" value="${table.tableNumber}" required
                            class="rounded border-gray-300 focus:ring-blue-500 focus:border-blue-500 px-2 py-1"/>
                        <button type="button" onclick="updateTable(${table.id})"
                            class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition">Save</button>
                    `;
                    numberCell.appendChild(form);
                } else {
                    numberCell.textContent = table.tableNumber;
                }
                row.appendChild(numberCell);
                
                // Occupied cell
                const occupiedCell = document.createElement('td');
                occupiedCell.className = 'px-4 py-2 border-b';
                occupiedCell.textContent = table.occupied;
                row.appendChild(occupiedCell);
                
                // Actions cell
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-4 py-2 border-b';
                
                if (editingTableId !== table.id) {
                    // Edit button
                    const editButton = document.createElement('button');
                    editButton.className = 'bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 transition mr-2';
                    editButton.textContent = 'Edit';
                    editButton.onclick = () => startEditing(table.id);
                    actionsCell.appendChild(editButton);
                }
                
                // Delete button
                const deleteButton = document.createElement('button');
                deleteButton.className = 'bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition';
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = () => deleteTable(table.id);
                actionsCell.appendChild(deleteButton);
                
                row.appendChild(actionsCell);
                
                tableBody.appendChild(row);
            });
        }

        // Function to start editing a table
        function startEditing(id) {
            editingTableId = id;
            loadTables(); // Refresh to show edit form
        }

        // Function to add a new table
        function addTable(event) {
            event.preventDefault();
            const tableNumber = document.getElementById('tableNumber').value;
            
            fetch('/api/tables?tableNumber=' + encodeURIComponent(tableNumber), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => {
                if (!response.ok) return response.text().then(text => { throw new Error(text) });
                return response.json();
            })
            .then(data => {
                document.getElementById('tableNumber').value = '';
                showAlert('Table added successfully');
                loadTables();
            })
            .catch(error => {
                showAlert('Error adding table: ' + error.message, true);
            });
        }

        // Function to update a table
        function updateTable(id) {
            const form = document.querySelector(`td form input[name="newTableNumber"]`);
            const newTableNumber = form.value;
            
            fetch(`/api/tables/${id}?newTableNumber=${encodeURIComponent(newTableNumber)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => {
                if (!response.ok) return response.text().then(text => { throw new Error(text) });
                return response.json();
            })
            .then(data => {
                editingTableId = null;
                showAlert('Table updated successfully');
                loadTables();
            })
            .catch(error => {
                showAlert('Error updating table: ' + error.message, true);
            });
        }

        // Function to delete a table
        function deleteTable(id) {
            if (!confirm('Are you sure you want to delete this table?')) return;
            
            fetch(`/api/tables/${id}`, {
                method: 'DELETE',
                headers: {
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to delete table');
                showAlert('Table deleted successfully');
                loadTables();
            })
            .catch(error => {
                showAlert('Error deleting table: ' + error.message, true);
            });
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            // Load tables on page load
            loadTables();
            
            // Set up form submission handler
            document.getElementById('addTableForm').addEventListener('submit', addTable);
        });
    </script>
</body>
</html>
